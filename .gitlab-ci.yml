include:
   - local: '/.gitlab-ci/templates.yml'

################################################
###################  DEBIAN  ###################
################################################

.build-env-debian-template-default: &build-env-debian-template-default
  <<: *build-env-template
  stage:
    build-env-default
  variables:
    OS_DISTRO: debian
  script:
    - OS_VERSION=$(echo $CI_JOB_NAME | cut -d- -f 1)
    - BUILD_TYPE=$(echo $CI_JOB_NAME | cut -d- -f 2)
    - sed -e "s %%OS_VERSION%% $OS_VERSION g" -e "s %%REGISTRY%% $CI_REGISTRY_IMAGE g" docker/nektar-env/Dockerfile_${OS_DISTRO}_${BUILD_TYPE} > Dockerfile
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - export IMAGE=$CI_REGISTRY_IMAGE:env-${OS_VERSION}-${BUILD_TYPE}
    - docker pull $IMAGE || true
    - docker build --pull -t $IMAGE .
    - docker push $IMAGE

.build-env-debian-template-full: &build-env-debian-template-full
  <<: *build-env-debian-template-default
  stage:
    build-env-full


# TEST ENVIRONMENTS
buster-default-build-env:
  <<: *build-env-debian-template-default

buster-full-build-env:
  <<: *build-env-debian-template-full

stretch-default-build-env:
  <<: *build-env-debian-template-default

stretch-full-build-env:
  <<: *build-env-debian-template-full


# BUILD AND TEST
buster-default-build-and-test:
  <<: *build-and-test-template

buster-full-build-and-test:
  <<: *build-and-test-template
  variables:
    OS_DISTRO: debian
    GIT_SUBMODULE_STRATEGY: recursive

stretch-default-build-and-test:
  <<: *build-and-test-template

stretch-full-build-and-test:
  <<: *build-and-test-template


# COMPILER WARNINGS
buster-default-warnings:
  <<: *compiler-warning-template

buster-full-warnings:
  <<: *compiler-warning-template

stretch-default-warnings:
  <<: *compiler-warning-template

stretch-full-warnings:
  <<: *compiler-warning-template


# DOCUMENTATION
buster-documentation-build-env:
  <<: *execution-conditions
  image: docker:19.03.6
  stage:
    build-env-full
  script:
    - export IMAGE=$CI_REGISTRY_IMAGE:env-documentation
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker pull $IMAGE || true
    - docker build --pull -t $IMAGE -f docker/nektar-env/Dockerfile_debian_documentation .
    - docker push $IMAGE

.build-documentation-template: &build-documentation-template
  <<: *build-and-test-template
  image: $CI_REGISTRY_IMAGE:env-documentation

user-guide-build:
  <<: *build-documentation-template
  script:
    - cmake -Bbuild -DCMAKE_BUILD_TYPE:STRING=Release -DNEKTAR_BUILD_LIBRARY:BOOL=OFF -DNEKTAR_BUILD_SOLVERS:BOOL=OFF -DNEKTAR_BUILD_UTILITIES:BOOL=OFF -DNEKTAR_BUILD_TESTS:BOOL=OFF -DNEKTAR_BUILD_DOC:BOOL=ON .
    - make -C build -j 3 user-guide-pdf user-guide-html developer-guide-pdf developer-guide-html
  artifacts:
    paths:
      - build/docs/user-guide/user-guide.pdf
      - build/docs/user-guide/html
      - build/docs/developer-guide/developers-guide.pdf
      - build/docs/developer-guide/html

doxygen-build:
  <<: *build-documentation-template
  script:
    - cmake -Bbuild -DCMAKE_BUILD_TYPE:STRING=Release -DNEKTAR_BUILD_LIBRARY:BOOL=OFF -DNEKTAR_BUILD_SOLVERS:BOOL=OFF -DNEKTAR_BUILD_UTILITIES:BOOL=OFF -DNEKTAR_BUILD_TESTS:BOOL=OFF -DNEKTAR_BUILD_DOC:BOOL=ON .
    - make -C build doc
  artifacts:
    paths:
      - build/docs/doxygen/html/

tutorials-build:
  <<: *build-documentation-template
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
  script:
    - cmake -Bbuild -DCMAKE_BUILD_TYPE:STRING=Release .
    - make -C build -j 2 tutorials-pdf tutorials-html
  artifacts:
    paths:
      - build/docs/tutorial/

################################################
###################  UBUNTU  ###################
################################################

.build-env-ubuntu-template-default: &build-env-ubuntu-template-default
  <<: *build-env-debian-template-default
  variables:
    OS_DISTRO: ubuntu

.build-env-ubuntu-template-full: &build-env-ubuntu-template-full
  <<: *build-env-ubuntu-template-default
  stage:
    build-env-full


# TEST ENVIRONMENTS
bionic-default-build-env:
  <<: *build-env-ubuntu-template-default

bionic-full-build-env:
  <<: *build-env-ubuntu-template-full

xenial-default-build-env:
  <<: *build-env-ubuntu-template-default

xenial-full-build-env:
  <<: *build-env-ubuntu-template-full

trusty-default-build-env:
  <<: *build-env-ubuntu-template-default

trusty-full-build-env:
  <<: *build-env-ubuntu-template-full


# BUILD AND TEST
bionic-default-build-and-test:
  <<: *build-and-test-template

bionic-full-build-and-test:
  <<: *build-and-test-template

xenial-default-build-and-test:
  <<: *build-and-test-template

xenial-full-build-and-test:
  <<: *build-and-test-template

trusty-default-build-and-test:
  <<: *build-and-test-template

trusty-full-build-and-test:
  <<: *build-and-test-template


# COMPILER WARNINGS
bionic-default-warnings:
  <<: *compiler-warning-template

bionic-full-warnings:
  <<: *compiler-warning-template

xenial-default-warnings:
  <<: *compiler-warning-template

xenial-full-warnings:
  <<: *compiler-warning-template

trusty-default-warnings:
  <<: *compiler-warning-template

trusty-full-warnings:
  <<: *compiler-warning-template

################################################
###################  CENTOS  ###################
################################################

.build-env-centos-template-default: &build-env-centos-template-default
  <<: *build-env-debian-template-default
  variables:
    OS_DISTRO: centos

.build-env-centos-template-full: &build-env-centos-template-full
  <<: *build-env-centos-template-default
  stage:
    build-env-full


# TEST ENVIRONMENTS
centos7-default-build-env:
  <<: *build-env-centos-template-default

centos7-full-build-env:
  <<: *build-env-centos-template-full


# BUILD AND TEST
centos7-default-build-and-test:
  <<: *build-and-test-template

centos7-full-build-and-test:
  <<: *build-and-test-template


# COMPILER WARNINGS
centos7-default-warnings:
  <<: *compiler-warning-template

centos7-full-warnings:
  <<: *compiler-warning-template

################################################
####################  OSX  #####################
################################################

.build-and-test-osx-template: &build-and-test-osx-template
  <<: *build-and-test-template
  tags:
    - macos
  script:
    - mkdir -p log
    - export OS_VERSION="osx"
    - export NUM_CPUS=8
    - bash -x ./.gitlab-ci/build-and-test.sh |
      tee log/${OS_VERSION}_${BUILD_TYPE}.log


# BUILD AND TEST
osx-default-build-and-test:
  <<: *build-and-test-osx-template
  variables:
    BUILD_TYPE: "default"

osx-full-build-and-test:
  <<: *build-and-test-osx-template
  variables:
    BUILD_TYPE: "full"


# COMPILER WARNINGS
osx-default-warnings:
  <<: *compiler-warning-template

osx-full-warnings:
  <<: *compiler-warning-template

################################################
#################  WINDOWS  ####################
################################################

win7-default-build-and-test:
  <<: *build-and-test-template
  tags:
    - win7
  script:
    - $Env:path = "$CI_PROJECT_DIR\build\dist\bin;$CI_PROJECT_DIR\ThirdParty;" + $Env:path
    - echo $Env:path
    - mkdir build
    - cd build
    - cmake.exe -G "Visual Studio 12 2013 Win64" --config Debug ..
    - cmake.exe --build . --target ALL_BUILD --config Debug
    - cmake.exe --build . --target INSTALL --config Debug
    - ctest --output-on-failure -C Debug -j3


win10-default-build-and-test:
  <<: *build-and-test-template
  tags:
    - win10
  script:
    - $Env:path = "$CI_PROJECT_DIR\build\dist\bin;$CI_PROJECT_DIR\ThirdParty;$CI_PROJECT_DIR\build\ThirdParty\dist\bin;" + $Env:path
    - echo $Env:path
    - mkdir build
    - cd build
    - cmake.exe -G "Visual Studio 14 2015 Win64" --config Debug ..
    - cmake.exe --build . --target ALL_BUILD --config Debug
    - cmake.exe --build . --target INSTALL --config Debug
    - ctest --output-on-failure -C Debug -j3
